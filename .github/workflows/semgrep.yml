name: Staging security test - DAST

on:
  push:

jobs:
  staging-sast-scan-code-test:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout action
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            
        - name: Fetch changes
          run: |
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT ${{github.event.pull_request.base.sha}} ${{github.sha}} | grep -E '*.js|*.jsx' | xargs)
            IFS=' ' tokens=($CHANGED_FILES)
            SCAN_FILES=$(echo "$CHANGED_FILES" | tr ' ' '\n' | sed 's/[^ ]* */--include=&/g' | tr '\n' ' ')
            echo "SCAN_FILES=$(echo $SCAN_FILES)" >> $GITHUB_ENV
        - name: Run semgrep
          uses: tsigouris007/action-semgrep-reviewdog@v[VERSION_NUMBER]
          with:
            github_token: ${{ secrets.github_token }}
            level: error
            reporter: github-pr-check
            filter_mode: nofilter
            semgrep_flags: "${{ env.SCAN_FILES }} --config=p/ci --disable-version-check"
            tool_name: Semgrep findings
            semgrep_ignore: "https://raw.github.com/repo/branch/semgrep.ignore"
